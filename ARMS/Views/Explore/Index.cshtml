@{
    ViewData["Title"] = "Explore";
}

<div class="page-content">
    <div>
        <div class="page-selection">
            <div>    
                <img class="m-x-15" src="@Url.Content("~/assets/icon/explore.png")" alt=""/>
                <label class="m-l-10 m-t-5" >Explore</label>
            </div>
            <div>
                <label class="m-x-10">Semester</label>
                <label for="semester"></label>
                <select id="semester" class="main-select">
                    <option selected="selected" disabled="disabled">Select Semester</option>
                </select>
                <label class="m-l-35 m-r-10">Session</label>
                <label for="session"></label>
                <select id="session" class="main-select">
                    <option selected="selected" disabled="disabled">Select Session</option>
                </select>
                <button id="button-search-explore" class="main-btn main-btn-second m-l-35 m-r-15" type="submit">
                    <img src="@Url.Content("~/assets/icon/search.png")" alt=""/> 
                    <span>Search</span>
                </button>
            </div>
        </div>
        <div id="explore-insight-partial"></div>
        <div id="explore-partial"></div>
    </div>
</div>

<script>    
    $(document).ready(function() {
        
        const reload = $('div[id$=main-reloading]');
        const semesterSelect = $('#semester');
        const sessionSelect = $('#session');
        const btnSearchExplore = $('#button-search-explore');
        const exploreInsightPartial = $('#explore-insight-partial');
        const explorePartial = $('#explore-partial');
                    
        $.getJSON('@Url.Action("CompletionSemesters", "Home")', function(res) {
            let selectIndex = 0;
            semesterSelect.empty();
            semesterSelect.append('<option selected=selected disabled=disabled>Select Semester</option>');         
            $.each(res, function(index, data) { 
                  if (data['isCurrent'] === true) {
                      selectIndex = index + 1;
                      semesterSelect.append('<option value="' + data['id'] + '">' + data['semesterText'] + '</option>');
                  } else {
                      semesterSelect.append('<option value="' + data['id'] + '">' + data['semesterText'] + '</option>');
                  }
            });
            semesterSelect.prop('selectedIndex', selectIndex);
            loadSessions();
        });
        
        semesterSelect.change(function() {
            loadSessions();
        });
        
        function loadSessions() {
            reload.show();
            exploreInsightPartial.empty();
            explorePartial.empty();
            const url = '@Url.Action("CompletionSessions", "Home")';
            $.ajax({
                type: 'POST',
                url: url,
                cache: true,
                dataType: 'json',
                data: { semesterId: semesterSelect.val() },
                success: function(res) {
                    sessionSelect.empty();
                    sessionSelect.append('<option selected=selected disabled=disabled>Select Session</option>');         
                    $.each(res, function(index, data) {
                        sessionSelect.append('<option value="' + data['examinationTypeId'] + '">' + data['nameEn'] + '</option>');
                    });
                    reload.hide(); 
                },
                error: function(error) {  
                    console.log('It is error!!!');
                    console.log(error);
                    loadErrorPage();
                }
            });
        }       
        
        sessionSelect.change(function() {
            exploreInsightPartial.empty();
            explorePartial.empty();
        }); 
        
        btnSearchExplore.click(function() {
            if (semesterSelect.val() != null && sessionSelect.val() != null) {
                reload.show();
                $.ajax({
                    type: 'POST',
                    url: `@Url.Action("ExploreInsight", "Explore")?semesterId=${semesterSelect.val()}&examinationTypeId=${sessionSelect.val()}`,       
                    cache: true
                }).done(function(res) {
                    exploreInsightPartial.empty().append(res);
                    loadAssignedCourse();
                }).fail(function(a, b, c) {
                    console.log('It is error');
                    console.log(c);
                    loadErrorPage();
                });
            } else {
                exploreInsightPartial.empty();
                explorePartial.empty();
            }
        });
        
        function loadAssignedCourse() {
            const sessionText = $('select[id$=session] option:selected').text();
            $.ajax({
                type: 'POST',
                url: `@Url.Action("AssignedCourse", "Explore")?semesterId=${semesterSelect.val()}&examinationTypeId=${sessionSelect.val()}&sessionText=${sessionText}`,
                cache: true
            }).done(function(res) {
                explorePartial.empty().append(res);
                reload.hide();
            }).fail(function(a, b, c) {
                console.log('It is error');
                console.log(c);
                loadErrorPage();
            });
        }
        
        function loadErrorPage() {
            const url = '@Url.Action("ErrorPage", "Home")';
            $.ajax({
                type: 'GET',
                url: url,
                cache: true
            }).done(function(res) {
                $('#main-page').empty().append(res);
                reload.hide();
            })
        }
    });
</script>